# Уровни переопределения

Определение
Принцип работы
Задачи
польза от уровней
Практические способы использования

## Определение

Уровень переопределения — это директория в БЭМ-проекте, которая содержит файлы реализаций [блоков](../key-concepts/key-concepts.ru.md#Блок), [элементов](../key-concepts/key-concepts.ru.md#Элемент) и [модификаторов](../key-concepts/key-concepts.ru.md#Модификатор).

С помощью уровней переопределения можно:
* [изменять реализацию блока](#)
* [подключать в проект дополнительные БЭМ-сущности](#)

Уровни переопределения позволяют:

* Избежать дублирования кода — выделить общую часть кода и подключать как отдельный уровень.
* Не создавать новые сущности, если необходимо изменить функциональность существующего блока (пере- и доопределение).
* Сократить время на отладку проекта — исправить ошибку в общем коде нужно один раз, правки применятся во все проекты.
* Организовать архитектуру проекта, чтобы [ускорить разработку, поддержку и эксперименты](#Как-использовать-уровни-переопределения). 

## Принцип работы уровней переопределения

* БЭМ-проект состоит из уровней переопределения
* Уровень переопределения содержит частичные или полные реализации блоков
* Конечная реализация блока собирается из исходных файлов с разных уровней переопределения

### БЭМ-проект состоит из уровней переопределения

В БЭМ-методологии реализация блока собирается из отдельных файлов технологий (`button.css`, `button.js`) — исходных файлов. Все исходные файлы проекта хранятся в группирующих директориях, если говорить в терминах БЭМ – на уровнях переопределения. 

Минимальное количество уровней переопределения в проекте – один. Максимальное – не ограничено. 

> Если в проекте один уровень переопределения, это значит, что блоки будут использоваться без изменений. 

Пример файловой структуры БЭМ-проекта с одним уровнем переопределения:

```files
project/
    blocks/                # уровень переопределения с блоками проекта
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
```

Пример файловой структуры БЭМ-проекта с двумя уровнями переопределения:

```files
project/
    common.blocks/                # уровень переопределения с блоками проекта
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
    library.blocks/               # уровень переопределения с блоками сторонней библиотеки
        button/
            button.css    
            button.js
        input/
            input.css    
            input.js
```

### Уровень переопределения содержит частичные или полные реализации блоков

Конечная реализация блока может: 
* хранится на одном уровне переопределения  
  Уровень переопределения может содержать готовые реализации блоков. Такие блоки могут подключаться в проект без изменений или дорабатываться на других уровнях переопределения. Например, уровнем переопределения с готовыми реализациями может быть библиотека блоков, подключенная в проект.

  Рассмотрим на примере подключенной библиотеки:

```files
project/
    project.blocks/         # базовые блоки проекта 
        header/
            header.css    
            header.js
        footer/
            footer.css    
            footer.js
    library.blocks/         # блоки подключенной библиотеки
        button/
            button.css    
            button.js
        input/
            input.css
            input.js
```

* разделяться по разным уровням переопределения   
  Уровень переопределения может содердать реализации блоков в отдельной технологии (например, только стили для кнопки `button.css`), или реализации дополнительных/отдельных элементов и модификаторов (например, иконки для шапки, характерные только для этого проекта).

Рассмотрим пример разделения реализации блока по уровням переопределения:

```files
project/
common.blocks/
    button/
        button.css    # базовая CSS-реализация кнопки

desktop.blocks/   
    button/
        button.css    # особенности кнопки для настольных устройств

mobile.blocks/
    button/
        button.css    # особенности кнопки для мобильных устройств
```

### Конечная реализация блока собирается из исходных файлов с разных уровней переопределения

Конечная реализация блока может быть разделена по разным уровням переопределения. Один уровень переопределения содержит исходную реализацию блока, а каждый последующий дополняет или перекрывает ее. Количество уровней и порядок их подключения может быть любым. Поэтому при сборке конечного результата важна последовательность подключения уровней переопределения в проект. В сборку сначала должна попасть исходная реализация, а затем — изменения со всех уровней переопределения. Для этого в настройках сборщика необходимо указать, с каких уровней и в каком порядке собирать исходные файлы. 

> Подробнее о [сборке БЭМ-проектов и порядке подключения БЭМ-сущностей в проект](https://ru.bem.info/methodology/build).

![схема работы уровней переопределения]()

## Задачи уровней переопределения

Уровни переопределения решают следующие задачи:
* [изменение существующей реализации блока](#)
* [подключение дополнительных БЭМ-сущностей в проект](#)

### Изменение существующей реализации блока

Уровень переопределения может добавлять новые свойства к исходной реализации блока (доопредедлять) и изменять существующие (переопределять). 

Рассмотрим на примере кнопки (блок `button`):
* Доопределим блок — добавим новое свойство, например, тень.
* Переопределим — измененим существующее свойство, например, перекрасим кнопку в другой цвет.

В файловой системе блок `button` расположен на уровне переопределения `common`, который содержит все базовые реализации блоков проекта.

```files
project/
    common/                # уровень переопределения common
        button/
            button.css
            button.js
```

Исходная CSS-реализация блока `button`:

```css
/* Блок button в технологии CSS на уровне common */

.button {
    color: red;
    height: 24px;
}
```

![Красная кнопка](https://raw.githubusercontent.com/innabelaya/bem-docs/master/pics/button_red.png)

Чтобы добавить всем кнопкам проекта новое свойство (тень) и изменить существующее свойство (цвет кнопки), создадим блок `button` на другом уровне проекта (`project`). Для этого создадим файл `button.css` на уровне `project` и напишем в него новые правила.

Файловая структура проекта с добавленным уровнем переопределения:

```files
project/
    common/                # уровень переопределения common
        button/
            button.css
            button.js
    project/               # уровень переопределения project
        button/
            button.css     
```

Дополнительные CSS-правила:

```css
/* Блок button в технологии CSS на уровне project */

.button {
    color: green;
    box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Параметры тени */
}
```

В результате сборки конечной реализации блока `button` к исходным CSS-правилам с уровня `common` добавятся новые — с уровня `project`:

```css
@import "common/button/button.css";    /* Базовые CSS-правила */
@import "project/button/button.css";   /* Особенности с уровня project */
```

Повторяющееся свойство (`color`) будет переопределно (кнопка из красной превратится в зеленую), а новое свойство (`box-shadow`) добавится. Блоку `button` применится следующий набор свойств:

```css
.button {
    color: red;
    height: 24px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
```

![Зеленая кнопка с тенью](https://raw.githubusercontent.com/innabelaya/bem-docs/master/pics/button_green_with-shadow.png)

В результате:
* у всех кнопок проекта изменился цвет и появилось новое свойство — тень;
* изменения вненсены в один файл, применились ко всем блокам проекта;
* исходная реализация блока `button` не изменилась;
* при необходимости вернуться к первоначальному виду блока, достаточно удалить уровень переопределния.

> **Важно** Можно переопределять не только CSS-свойства блока, но и его [методы](https://ru.bem.info/methodology/js/#Работа-с-уровнями-переопределения) и шаблоны.  
В БЭМ-проекте любая технология реализации блока может быть пере- или доопределена. Подробнее читайте в разделе [Платформа](https://ru.bem.info/platform/bem-xjst/runtime/).

> Изменять исходную реализацию блока можно с помощью [новых элементов или модификаторов](#Добавление-новых-БЭМ-сущностей-в-проект), добавленных на новом уровне переопределения.

### Добавление новых БЭМ-сущностей в проект

С помощью уровней переопределения можно не только [изменять](#Изменение-реализации-блока) уже существующие БЭМ-сущности, но и добавлять новые:

* [Добавление блоков](#)
* [Добавление элементов](#)
* [Добавление модификаторов](#)

#### Добавление блоков

Рассмотрим пример, в котором добавим блок с дополнительного уровня переопределения в проект. 

```files
project/
    common/                             # уровень переопределения common, блоки проекта
        button/
            button.css
            button.js
    libs/                               # уровень переопределения c блоками библиотеки
        logo/                           # блок logo 
            logo.css                    # реализация блока logo в технологии CSS
            logo.js
```

Чтобы блок `logo` с уровня `blocks` попал в сборку, необходимо:

* указать блок `logo` в описании блоков, которые используются в построении страницы;
* подключить уровень переопределения `blocks` в настройках сборщика. 

```css
@import "common/button/button.css";     /* CSS-правила блока button */
@import "blocks/logo/logo.css";         /* CSS-правила блока logo */
```

#### Добавление элементов



![Базовая реализация кнопки из библиотеки](https://github.com/innabelaya/bem-docs/blob/master/pics/button_white.png?raw=true)
![Кнопка со стрелкой](https://github.com/innabelaya/bem-docs/blob/master/pics/button_white_with-arrow.png?raw=true)


#### Добавление модификаторов

> Аналогичным способом можно добавлять элементы и модификаторы любому блоку. Дополнительные элементы и модификаторы могут изменить внешний вид или поведение базового блока. 

![Базовая реализация кнопки из библиотеки](https://github.com/innabelaya/bem-docs/blob/master/pics/button_white.png?raw=true)
![Кнопка с модификатором темы](https://github.com/innabelaya/bem-docs/blob/master/pics/button_yellow.png?raw=true)


Принцип работы уровней переопределения
Задачи уровней переопределения
Плюсы 
Способы использования Уровней переопределения на практике






БЭМ-проект состоит из уровней переопределения. Количество уровней переопределения неограничено. 

Каждый уровень переопределения содержит реализации блоков в различных технологиях — исходные файлы. 

Реализация блока может находиться на разных уровнях переопределения. В БЭМ используется сборка. Исходные файлы собираются последовательно в указанном порядке со всех уровней переопределения. Так получается конечная реализация блока. При сборке исходные файлы могут накладываться друг на друга и изменять исходную реализацию блока. Последовательность подключения уровней переопределения в борку может быть любой и определяется на этапе сборки. 

Рассмотрим пример























Любой БЭМ-проект состоит из уровней переопределения. Количество уровней в проекте неограниченно, минимум один. 

В БЭМ конечная реализация блока может быть разделена по разным уровням переопределения. Если в проекте один уровень переопределения, это значит, что реализации БЭМ-сущностей будут использоваться без изменений. 

Каждый дополнительный уровень может изменять исходную реализацию блока

В БЭМ конечная реализация блока может быть разделена по разным уровням переопределения. Для этого проект должен состоять минимум из двух уровней переопределения. Каждый дополнительный уровень может [изменять исходную реализацию блока]() или [добавлять новые готовые блоки]() в проект. 



Поэтому важно, чтобы сначала в сборку попадала исходная реализация, а затем изменения со всех уровней переопределения. Ниже приведен пример проекта с уровнями переопределения common.blocks, desktop.blocks, touch.blocks.


```files
project/
    level/                              # уровень переопределения
        block1/                         
            __elem1/                    
                block1__elem1.js        # файл реализации элемента elem1 блока block1 в технологии JavaScript
            _mod1/                      
                block1_mod1.css         # файл реализации модификатора mod1 блока block1 в технологии CSS
            block1.css                  # файл реализации блока block1 в технологии CSS
            block1.js                   # файл реализации блока block1 в технологии JavaScript
        block2/                         
            block2.css                  # файл реализации блока block2 в технологии CSS
            block2.js                   # файл реализации блока block1 в технологии JavaScript
        block3/
        block4/
```

> Подробнее о [принципах организации файловой структуры БЭМ-проекта](../filestructure/filestructure.ru.md)



## Задачи уровней переопределения

Уровни переопределения дают возможность:

* [Изменять исходную реализацию БЭМ-сущностей](#Изменение-реализации-блока)
* [Подключать в проект дополнительные БЭМ-сущности](#Подключение-дополнительных-БЭМ-сущностей)

### Изменение реализации блока

В БЭМ-методологии реализация блока распределена по отдельным файлам технологий (`button.css`, `button.js`) — исходным файлам. Реализация блока в любой из технологий (например, `.css`) может быть разделена по разным уровням переопределения. Каждый дополнительный уровень может добавлять новые свойства блоку (доопределять, наследовать) или изменять старые (переопределять).

Финальная реализация блока собирается со всех уровней последовательно в указанном порядке. Чтобы получить желаемый конечный результат блока, в настройках сборщика необходимо указать, с каких уровней и в каком порядке собирать исходные файлы. Количество уровней и порядок их подключения может быть любым.

> **Аналогия** Уровни переопределения ведут себя как слои в графическом редакторе: базовый слой – это исходная реализация блока, а каждый последующий слой накладывается сверху и дополняет (наследует) или изменяет базовую реализацию.

![Уровни переопределения](../key-concepts/key-concepts__levels.png)

Пример переопределения CSS-свойств блока:

```files
project/
    common/                # уровень переопределения common
        button/
            button.css
            button.js
    project/               # уровень переопределения project
        button/
            button.css
```

CSS-реализация

```css
/* Блок button в технологии CSS на уровне common */

.button {
    color: red;
    height: 24px;
}

/* Блок button в технологии CSS на уровне project */

.button {
    color: green;
    font-size: 11px;
}
```

В результате сборки: 
* переопределятся повторяющиеся свойства (`color`) для блока `button` (кнопка из красной превратится в зеленую);
* добавится новое свойство (`font-size`). 

```css
@import "common/button/button.css";    /* Базовые CSS-правила */
@import "project/button/button.css";   /* Особенности с уровня project */
```

В браузере для блока `button` применится следующий набор свойств:

```css
.button {
    color: green;
    height: 24px;
    font-size: 11px;
}
```

> **Важно** Можно переопределять не только CSS-свойства блока, но и его [методы](https://ru.bem.info/methodology/js/#Работа-с-уровнями-переопределения) и шаблоны.  
В БЭМ-проекте любая технология реализации блока может быть пере- или доопределена. Подробности в разделе [Платформа](https://ru.bem.info/platform/bem-xjst/runtime/).

### Подключение дополнительных БЭМ-сущностей

С помощью уровней переопределения можно не только [изменять](#Изменение-реализации-блока) уже существующие БЭМ-сущности, но и добавлять новые. 

* [](#)
* [](#)
* [](#)

Рассмотрим пример, в котором добавим блоки с дополнительного уровня переопределения в проект. 

```files
project/
    common/                             # уровень переопределения common, блоки проекта
        button/
            button.css
            button.js
    blocks/                             # уровень переопределения blocks, дополнительная библиотека
        logo/                           # блок logo 
            logo.css                    # реализация блока logo в технологии CSS
```

Чтобы блок `logo` с уровня `blocks` попал в сборку, необходимо:

* указать блок `logo` в описании блоков, которые используются в построении страницы;
* подключить уровень переопределения `blocks` в настройках сборщика. 

```css
@import "common/button/button.css";     /* CSS-правила блока button */
@import "blocks/logo/logo.css";         /* CSS-правила блока logo */
```

> Аналогичным способом можно добавлять элементы и модификаторы любому блоку. Дополнительные элементы и модификаторы могут изменить внешний вид или поведение базового блока. 

## Как использовать уровни переопределения

Уровни переопределения позволяют организовать архитектуру проекта, чтобы:

* [Подключать библиотеки](#Проект-и-библиотеки) и обновлять их, не делая правок в коде.
* [Выделять общие части реализаций блоков](#Изменения-в-типовых-проектах) на один уровень, а частные случаи (например, специфическую реализацию для отдельных сервисов) — на другой.
* [Разделять проект на платформы](#Разделение-проекта-на-платформы). Общую реализацию для всех платформ хранить на одном уровне, а платформо-специфичную — выносить на другой.
* [Экспериментировать](#Проект-и-эксперименты) в рабочем проекте.
* [Иметь разные дизайны проекта](#Проект-и-дизайн).

### Проект и библиотеки

Библиотека подключается в БЭМ-проект как отдельный уровень. Изменять (до- или переопределять) блоки из этой библиотеки под требования проекта необходимо на другом уровне. При сборке следует подключать исходную реализацию блоков с уровня библиотеки и измененную — с уровня проекта.

Когда выйдет новая версия библиотеки, обновление не затронет изменения блоков для проекта, так как библиотека находится на одном уровне переопределения, а специфические реализации (доработки) блоков — на другом.

Рассмотрим на примере:

```files
project/
    library.blocks/
        button/
            button.css    # CSS-реализация кнопки в библиотеке (высота 20px)

    project.blocks/
        button/
            button.css    # переопределение на уровне проекта (высота 24px)
```

Если в новой версии библиотеки изменится высота кнопок (например, станет 18px), после обновления в проекте для блока `button` в браузере все равно применится переопределенное правило — 24px.

> Разделение по уровням переопределения позволяет сохранить изменения в блоках при обновлении библиотеки. 

### Разработка одного проекта на основе другого

Чтобы создать новый сайт на базе существующего или добавить похожую по структуре страницу для портала, можно скопировать общую часть кода и затем добавить специфичные реализации. А можно использовать уровни переопределения и хранить общий код на одном уровне, а специфику каждой страницы или каждого сайта — на других уровнях.

Что дают уровни в этом случае:
* нет необходимости копировать общую часть кода из проекта в проект;
* исправить ошибку в общем коде нужно один раз, правки применятся во все проекты;
* всегда можно переопределить часть общего кода под новые требования заказчика.


```files
project/                            
    blocks/                         # общие блоки для всего портала
        head/
            head.css
            head.js
        foot/
            foot.css
        sidebar/
            sidebar.css
            sidebar.js
    pages/                          # специфика реализации для отдельных страниц
        index/
            head/
                head.css            # изменение шрифта в шапке на заглавной странице
        about/
            about-text/             # добавление нового блока
                about-text.css
```

### Разделение проекта на платформы

Проект, поддерживающий разные платформы (например, `mobile` и `desktop`), всегда имеет общую функциональность и платформо-специфичную. Чтобы не копировать общую часть кода для реализации каждой из платформ, используются уровни переопределения: 

* common — общая реализация блоков для всех платформ;
* desktop — специфическая реализация блоков для настольных устройств;
* mobile — специфическая реализация блоков для мобильных устройств.

Рассмотрим на примере:

```files
project/
    common.blocks/
        button/
            button.css    # базовая CSS-реализация кнопки

    desktop.blocks/   
        button/
            button.css    # особенности кнопки для настольных устройств

    mobile.blocks/
        button/
            button.css    # особенности кнопки для мобильных устройств
```

При сборке в файл `desktop.css` попадут все базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `desktop`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "desktop.blocks/button/button.css";   /* Особенности desktop */
```

Файл `mobile.css` будет включать базовые CSS-правила кнопки с уровня `common` и переопределенные правила с уровня `mobile`.

```css
@import "common.blocks/button/button.css";    /* Базовые CSS-правила */
@import "mobile.blocks/button/button.css";    /* Особенности mobile */
```

### Проект и эксперименты

Уровни переопределения позволяют проводить A/B тестирование непосредственно в рабочем проекте. При этом существующий код проекта менять не нужно. 

Рассмотрим пример, когда проект уже запущен, а заказчик хочет внести изменения. Например, предлагает разные варианты отображения личного фото пользователей. Разработчик должен изменить все фотографии всех пользователей на всех страницах сайта, провести тестирование и выбрать наиболее подходящий вариант. 

В большинстве проектов без уровней переопределения необходимо:
* найти все случаи использования блока `user-pic` на каждой странице (предположим, что блок встречается на странице 15 раз, а страниц на сайте +100500) 
* написать для каждого случая условие проверки (`if`);  
    ```
      if (пользователь попал в эксперимент 'круг')
      {
      отобрази фотографии пользователей в круглыми;
      };
      if (пользователь попал в эксперимент 'квадрат')
      {
      отобрази фотографии пользователей в квадратными;
      };
    ```

* выбрать финальный вариант;
* возможно, понять, что ни один вариант не подходит, и продолжить эксперименты с новыми вариантами;
* удалить изменения для каждого случая на каждой странице;
* применить выбранные изменения для каждого случая.

Чтобы провести такое тестирование в БЭМ-проекте достаточно создать отдельный уровень переопределения для каждого эксперимента.

```files
project/                    
    blocks/                 # блоки проекта
        user-pic/           # блок `user-pic`
        ...
    tests/
        test-circle/        # уровень для эксперимента 'круг'
            user-pic/       # блок `user-pic` с измененными круглыми фотографиями 
        test-square/        # уровень для эксперимента 'квадрат'
            user-pic/       # блок `user-pic` с измененными квадратными фотографиями  
        test-n/             # уровень для любого нового эксперимента
            user-pic/       # блок `user-pic` с любыми новыми изменениями
```

Во время экспериментов код рабочего проекта не изменяется. 

Чтобы убрать из проекта неподходящий вариант, достаточно удалить директорию — уровень переопределения неудачного эксперимента.

> Так же можно проводить эксперименты, меняя поведение блока или разметку страницы. Например, если необходимо добавить новые теги для обеспечения доступности сайта (a11y). В этом случае переопределяются шаблоны и JavaScript-код.

### Проект и дизайн

Поведение и внешний вид проекта можно разделить на разные уровни переопределения. Бизнес-логика не меняется в зависимости от переключения дизайна, поэтому находится на отдельном уровне (`common`). Код, отвечающий за внешний вид проекта, вынесен на уровень дизайна (`design`).

```files
common/             # бизнес-логика проекта
    button/
    input/
    ...
design/             # внешний вид проекта
    alfa/           # дизайн проекта alfa
        button/
        input/
    beta/           # дизайн проекта beta
        button/
        input/
```

Для добавления нового дизайна необходимо создать дополнительный уровень переопределения, пере- или доопределить существующие блоки и включить данный уровень в сборку.

## Что дают уровни переопределения

